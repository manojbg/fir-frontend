<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
    <script src="./scripts.js"></script>
    <style>
        /* Set A4 size */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family:"Times New Roman",sans-serif;
            font-size:17px;
        }

        @page {
            size: A4;
            margin: 2%;
        }
        html{
        height:297mm;
        width:210mm;
        margin-left:auto;
        margin-right:auto;
        }

        body{
        margin: 2%
        }

        td {
        border: 1pt solid windowtext;
        }

        table td div{
        padding : 1%
        }

        input{
        border : none
        }

        span[placeholder]:empty:before {
        content: attr(placeholder);
        color: #555;
        }

        span { cursor:pointer; }

        .background-edit {
        background-color : yellow;
        }

        .save-button {
        display: inline;
        border-radius: 15px;
        background-color: #4CAF50;
        color: white;
        font-size: 20px;
        width: 40%;
        height: 45px;
        }

        .save-button:hover {
        background-color: #45a049;
        }

        .removeBtn, .removeColumnBtn{
          background: rgba(211, 211, 211, 1.0);
          width: 100%
        }

        .removeBtn:hover, .removeColumnBtn:hover{
          background: rgba(183, 183, 183, 1.0);
        }

        .addColumnBtnAfter, #addRowBtnAfter {
          background: #4CAF50;
          width: 100%
        }

        .addColumnBtnAfter:hover, #addRowBtnAfter:hover {
          background-color: #45a049;
        }
    </style>
    <script>
        $(document).ready(function () {
          $("#addRowBtnAfter").click(function () {
            const numberOfCells = document.getElementById('table1').rows[0].cells.length;
            var newRow =$('<tr></tr>');
            //one extra cell is to be considered for the colspan=2 column
            for(let i = 1; i <= numberOfCells; i++)
            {
              newRow.append("<td><div class='background-edit' contenteditable></td>");
            }
            newRow.append("<td><button class='removeBtn'>Delete <br> Row</button></td>");
            $("#table1 tbody tr:last").after(newRow);
          });

          // Remove a row from the table
          $(document).on("click", ".removeBtn", function () {
              $(this).closest("tr").remove();
          });

          // Remove a column from the table
          $(document).on("click", ".removeColumnBtn", function () {
              var columnIndex = $(this).closest("td")[0].cellIndex;
              deleteSelectedColumn(columnIndex);
          });
          fetchData();
        });
        window.onload = getQueryParams;

        //Add a column to the table
        function addColumn() {
          const numberOfCells = document.getElementById('table1').rows[0].cells.length;
          removeLastColumn();
          var newColumn =$('<td></td>');
          $("#table1 tr").each(function(){
            var row = $(this);
            if(row[0].className == "headers")
             {
               $(this).append("<td rowspan='2'><div class='background-edit' contenteditable></td>");
               $(this).append("<td rowspan='2'>ACTIONS</td>");
             }
             else if(row[0].className == "deleteColumnBtnRow")
             {
               $(this).append("<td><button class='removeColumnBtn'>Delete <br> Column</button></td>");
               $(this).append("<td><button class='addColumnBtnAfter' onclick='addColumn()'>Add <br> Column</button></td>");
             }
             else if(row[0].id == "period")
             {
               //skip row
             }
             else
             {
               $(this).append("<td><div class='background-edit' contenteditable></td>");
               $(this).append("<td><button class='removeBtn'>Delete <br> Row</button></td>");
             }
          })
          $("#table1 tr > *:last-child").css("width","90px");
        }

        function save(print) {
          // Get the content inside modal-body
          hideElementsForView();
          const closebuttons = document.getElementById("iclose");
          var tableContent = getTableData("table1");

          // Traverse up to the <body> or <html> element for the content
          const elementToConvert = document.getElementById("bodyMain");
          if (!elementToConvert) {
            console.error("Element to convert not found");
            return;
          }

          const obj = {
            date: $("#datePicker").val(),
            networkProvider: $('#networkProvider option:selected').text(),
            psi: $('#psi').text(),
            ioa: $('#ioa').text(),
            table1: tableContent,
          };

          const firNumber = document.getElementById("firNumberField").textContent;
          const formName = document.getElementById("formNameField").textContent;
          const pk = document.getElementById("pk").textContent;
          $('paramsHolder').remove();

        // Pass the element for PDF generation
          convertHtmlToPdfDirectly(elementToConvert, (error, byteArray) => {
            if (error) {
              console.error("Error in convertHtmlToPdfDirectly:", error);
              return;
            }
            const req = {
            Pk: pk,
            FileContent: JSON.stringify(obj),
            FileName: formName,
            FirNumber: firNumber,
            FileBytes: byteArray,
          };
            saveAPICall(req, print);
          });
        }

        // Function to fetch data and populate the fields
        function fetchData() {
          const params = new URLSearchParams(window.location.search);
          const pk = params.get("pk");
          const type = params.get("type");
          if(type == "edit"){
            $.ajax({
              url: globalOptions.uri+"?supportingDocumentId="+pk,
              type: "GET",
              success: function (response) {
                const jsonObject = JSON.parse(response.FileContent);
                $("#datePicker").val(jsonObject.date || "");
                $('#networkProvider option:selected').text(jsonObject.networkProvider || "");
                populateIPDRTable("table1", jsonObject.table1 || []);
                },
                error: function (error) {
                    console.error("Error fetching data:", error);
                    handleModalError();
                }
            });
          }
        }

        function hideElementsForView()
        {
           removeLastColumn();
           $('#addRowBtnAfter').remove();
           $('#saveForm').remove();
           $('#printForm').remove();
           $('.background-edit').removeClass();
           document.getElementById('networkProvideDiv').innerHTML = "<b>"+$("#networkProvide option:selected").text()+"</b>";
           $('.deleteColumnBtnRow').remove();
           if(document.getElementById('table1').rows.length < 2)
           {
             $('#table1').remove();
           }
        }

        function deleteSelectedColumn(columnIndex)
        {
           const tableRows =  document.getElementById('table1').querySelectorAll("tbody tr");
           tableRows.forEach(row =>{
             if(row.className !== "headers" && row.className !== "deleteColumnBtnRow")
             {
               if(row.id !== "period")
               {
                 row.children[columnIndex+1].remove();
               }
             }
             else
             {
               row.children[columnIndex].remove();
             }
           });
        }

        function removeLastColumn()
        {
           const tableRows =  document.getElementById('table1').querySelectorAll("tbody tr");
           tableRows.forEach(row =>{
           if(row.id !== "period")
           {
             row.children[row.children.length-1].remove();
           }});
        }

        function populateIPDRTable(tableId, data)
        {
          if(data !== null)
          {
            const table = document.getElementById(tableId);
            const tbody = table.querySelector("tbody");
            tbody.innerHTML = ""; // Clear existing rows

            const deleteColumnBtnRow = $('<tr class="deleteColumnBtnRow"></tr>');
            for(let i=0; i < Object.keys(data[0]).length; i++)
            {
              if(i < 2)
              {
                deleteColumnBtnRow.append("<td style='color:red'>Cannot Delete</td>");
              }
              else if(i == 2)
              {
                deleteColumnBtnRow.append("<td colspan='2' style='color:red'>Cannot Delete</td>");
              }
              else
              {
                deleteColumnBtnRow.append("<td><button class='removeColumnBtn'>Delete <br/> Column</button></td>");
              }
            }
            deleteColumnBtnRow.append("<td><button class='addColumnBtnAfter' onclick='addColumn()'>Add <br/> Column</button></td>");
            $("#"+tableId+" tbody").append(deleteColumnBtnRow);
            data.forEach(row => {
              const newRow = $('<tr></tr>');
              Object.keys(row).forEach(function(key,index) {
                if(table.rows.length < 3)
                {
                  if(table.rows.length == 1 && key == 2)
                  {
                    newRow.append("<td colspan='2'><div>"+row[key]+"</div></td>");
                  }
                  else if(table.rows.length == 2)
                  {
                    newRow.append("<td><div>"+row[key]+"</div></td>");
                  }
                  else
                  {
                    newRow.append("<td rowspan='2'><div>"+row[key]+"</div></td>");
                  }
                }
                else
                {
                  newRow.append("<td><div class='background-edit' contenteditable>"+row[key]+"</div></td>");
                }
              });
              if(table.rows.length == 1)
              {
                newRow.append("<td rowspan='2'>ACTIONS</td>");
              }
              else if(table.rows.length == 2)
              {}
              else
              {
                newRow.append('<td><button class="removeBtn">Delete <br> Row</button></td>');
              }
              $("#"+tableId+" tbody").append(newRow);
            });
            $("#"+tableId+" tr:first").attr("class","deleteColumnBtnRow");
            $("#"+tableId+" tr:nth-child(2)").css({ "font-weight": "bold" });
            $("#"+tableId+" tr:nth-child(2)").attr("class","headers");
            $("#"+tableId+" tr:nth-child(3)").attr("id","period");
            $("#"+tableId+" tr > *:last-child").css("width","90px");
          }
        }
    </script>
</head>
<body id="bodyMain">
<div id="divMain">
<p style='text-align:center;'><strong><span >Annexure IX</span></strong></p>
<p style='text-align:center;'><strong><span >Performa to seek Call Data/Detail Record</span></strong></p>
<p style='text-align:center;'><strong><span >(Request Under Section 94 of the BNSS 2023)</span></strong></p>
<p style='text-align:justify;'><span >&nbsp;</span></p>
<div style="display: inline-block;width: 30%;">
    <p><strong>To,</strong></p>
    <div style="text-indent:18.0pt">The Nodal Officer</div>
    <div id="networkProvideDiv" style="text-indent:18.0pt">
       <select id="networkProvider" class="background-edit">
        <option value="AIRTEL">AIRTEL</option>
        <option value="BSNL" selected="selected">BSNL</option>
        <option value="JIO">JIO</option>
        <option value="VODAFONE">VODAFONE IDEA</option></select>
     </div>
</div>
<br/><br/>
<div style='text-align:center'>Kindly arrange to provide the <strong>IPDR</strong> for the following</div>
<br/>
    <table id="table1" style="border-collapse: collapse;border: none;text-align:center; table-layout : fixed">
        <tbody>
        <tr class="deleteColumnBtnRow" style="font-weight: bold;">
            <td style="color:red">Cannot Delete</td>
            <td style="color:red">Cannot Delete</td>
            <td colspan="2" style="color:red">Cannot Delete</td>
            <td><button class='removeColumnBtn'>Delete <br/> Column</button></td>
            <td><button class='removeColumnBtn'>Delete <br/> Column</button></td>
            <td style="width:90px"><button class="addColumnBtnAfter" onclick="addColumn()">Add <br/> Column</button></td>
        </tr>
        <tr class="headers" style="font-weight: bold;">
            <td rowspan="2" style="width:50px">
                <div>SL No.</div>
            </td>
            <td rowspan="2">
                <div>IPDR NUMBER</div>
            </td>
            <td colspan="2">
                <div>PERIOD (DD-MM-YYYY) (HH:MM:SS, IST)</div>
            </td>
            <td rowspan="2">
                <div class="background-edit" contenteditable>FIR / CASE NO</div>
            </td>
            <td rowspan="2">
                <div class="background-edit" contenteditable>PS &amp; SECTIONS OF LAW</div>
            </td>
            <td rowspan="2" id="actions" style="width:90px">
                <div>ACTIONS</div>
            </td>
        </tr>
        <tr id="period">
            <td>
                <p>FROM</p>
            </td>
            <td >
                <p>TO</p>
            </td>
        </tr>
        <tr>
            <td>
                <div class="background-edit" contenteditable>01</div>
            </td>
            <td>
                <div class="background-edit" contenteditable></div>
            </td>
            <td>
                <div class="background-edit" contenteditable></div>
            </td>
            <td>
                <div class="background-edit" contenteditable></div>
            </td>
            <td>
                <div class="background-edit" contenteditable></div>
            </td>
            <td>
                <div class="background-edit" contenteditable></div>
            </td>
            <td>
                <button class="removeBtn">Delete <br> Row</button>
            </td>
        </tbody>
    </table>
<button style="float:right" id="addRowBtnAfter">Add Row</button>
<br/>
<p>&nbsp;<strong><span >Reason/Case Brief:</span></strong></p>
<br/>
<ol style="margin-left: 2%">
    <li><span >The subscriber identity has been ascertained and it is ensured that person in question is not someone whose call details are of a sensitive nature.</span></li>
    <li><span >The number is not subscribed in the name of a sitting MP/MLA/MLC &amp; Governor.</span></li>
</ol>
<br/><br/>
<p>Place: Bengaluru</p>
<p><strong><span>Date: <input type="date" id="datePicker" class="background-edit"></span></strong></p>
<br/><br/>
    <div class="noSplit">
<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Regards</span>
<div style="display: inline-block;width: 100%;">
    <div style="float : right; text-align:center; width : 35%">
        <p>Assistant commissioner of police,</p>
        <p><strong>CEN police station,</strong></p>
        <p><strong>North division, Bengaluru city</strong></p>
    </div>
</div>
    </div>
<div><b>PSI : </b> <div id="psi" style="display:inline; font-weight:bold" class="background-edit" contenteditable>RAJU</div></div>
<div><b>IOA : </b> <div id="ioa" style="display:inline; font-weight:bold" class="background-edit" contenteditable>MAHENDRA S</div></div>
<br/>
</div><br/>
<button class="save-button" id="saveForm" title="Save Document" onclick="save(false)">Save</button>
<button class="save-button" id="printForm" style="float:right" title="Save Document And Print" onclick="save(true)">Save & Print</button>
<div id="paramsHolder">
<p style="display: none;">FIR Number: <span id="firNumberField"></span></p>
<p style="display: none;">Form Name: <span id="formNameField"></span></p>
<p style="display: none;">Action Type: <span id="actionType"></span></p>
<p style="display: none;">PK: <span id="pk"></span></p>
</div>
</body>
</html>